= Initializing Replications
:page-aliases: running-replications
:page-layout: article
:page-status: {release-status-sgw} -- {release-comments-sgw}
:page-edition: Under Development
:page-role: panes
:description: This content covers how to initialize and run inter-cluster replication (replication between Sync Gateway clusters)
:keywords:

include::partial$_std-hdr-sgw.adoc[]

include::partial$block-authors-notes.adoc[tag=wip]

:topic-group: Inter-cluster Replication
:param-related: {xref-sgw-pg-config-properties} | {xref-sgw-pg-rest-api-admin} | {xref-sgw-pg-icr-admin}
:param-abstract:
include::partial$block-abstract.adoc[]


ifeval::["{releaseStatus}" == "gamma"]
[.pane__frame--orange]
.Author's Notes
--
Document relevant aspects of _Running and Managing Replications_
Information sources include:

* Existing content from xref:2.7@sync-gateway.running-replications.adoc[Running Replications] as below
* https://issues.couchbase.com/browse/DOC-6465
* https://docs.google.com/document/d/13E6JOq8u_AaUd_t8FZEPCAuq7jfkjryecjBQBHE3pG8/edit?ts=5e77c903#heading=h.nsn5wnqrbttx


.points to cover also include:
done-7/27/20
* Replications defined in the root level config that donâ€™t have a local database as source or target will
Log an error, prevent SG from starting (breaks backward compatibility without proper deprecation notice)
+
NOTE: We are not aware of any existing deployments that use this model. Hence the decision was to remove this as there is no real use case to support this model.
+
Documentation : Highlight this breaking change in our release notes and in main documentation section. Replications will always run will source or target as the local database. IT cannot be set up between two remove databases
+ from https://docs.google.com/document/d/13E6JOq8u_AaUd_t8FZEPCAuq7jfkjryecjBQBHE3pG8/edit?ts=5e873940#heading=h.4s8odjf16mf1 need to also cover here and on configuration too

--
endif::[]

:fn-restonly-par: footnote:fn-restonly[This parameter is not available in the configuration file.]
:fnref-restonly: footnote:fn-restonly[]


// == Overview

// Inter-custer replication supports both persistent and ad hoc replication types.

// You can initialize a persistent inter-cluster replication by using either of these methods:

// * Configuring it in the node's configuration file (`sync-gateway-config.json`)
// * Using {xref-sgw-pg-rest-api-admin} requests through a utility such as `curl`, or an application such as _Postman_

// You can also initialize ad hoc inter-cluster replications by using the
//  {xref-sgw-pg-rest-api-admin}.

== Initialization


All replications operate within the context of a local database:


* Configured replications use the `database.{db-name}.replications` property to add a replication definition to a local database.
* REST API replications specify the local database and replication identity in the API POST/PUT request.
Providing the replication definition parameters in the request body as a JSON string.

Both of these scenarios and a summary of the available replication properties are shown in <<replication-properties>>.
It is a brief introduction to the replication properties, which are covered in more detail in {xref-sgw-pg-config-properties} (the definitions apply to configured and API replications).

Replication highlights:

* There are two types of replication: persistent and ad hoc (REST API only).
* Replications of both types can run in one-shot or continuous replications modes.
* All replications involve at least one local database.
* Replications can be configured to purge documents when channel access is revoked (a removal notification is received).

* Persistent continuous replications can be:
** Reset -- checkpoint back to starting value ?? check
** Updated -- only the parameter values provided in the PUT request body will be updated

* Persistent and ad hoc replications can be:
** Removed -- only the replication_id is needed to delete ongoing continuous or one-shot replications.

* {enterprise} only:
** Replications can use delta-sync mode, whereby only the changed data-items are replicated.


 Running highlights

* Multiple identical replicators can be initiated on a Sync Gateway node provided each has a unique `replication_Id`.
* SGR-1 and SGR-2 replications can run on the same node, but you must ensure that they each have a different `replication_id`.
* The user under which replication is being run must have read and write access to the data being replicated.
* Exponential backoff when connection lost. Doesn't apply to `adhoc`.
* SGR-2 will continue trying to connect for 30 minutes following authentication failure (including user-invalid/doesn't exist).
* Running replications can be stopped. Stopped replications can be (re)Started.
// [On disconnected replications, replication will it will do exponential backoff upto reconnect-interval and then attempt to reconnect indefinitely based on this value. If 0, it will do exponential backoff upto 5 min before stopping the replication]

* If ALL the Sync Gateway nodes in a source or target Sync Gateway cluster go down in the middle of continuous replication, by default, the system should pick up from the last document that was successfully processed by both sides when the replication/cluster is restarted


* REST ONLY
** POST databases/{db}/_replication creates a replication using the {rep-id} specified in the body or if none specified, a unique UUID.
** PUT databases/{db}/_replication/{rep-id} upserts replication {rep-id}.


* {enterprise} only:
** Replications are distributed even across all available Sync Gateway nodes and so are not guaranteed to run on their originating node.
** If a multi-node Sync Gateway cluster loses a subset of sync gateway nodes, the remaining nodes continue replication uninterrupted IF they have been configured to handle the replication (continuous and one-shot replications).

include::partial$icr-repl-props-table-sgr2.adoc[]





// The `replications` value is an array of objects.
// Each object defines a single replication.

// // One-shot replications are always run asynchronously even if the `async` property is not set to true.

// Replications may be given a user defined `replication_id` otherwise Sync Gateway will generate a random UUID.

// Replications defined in config may not contain the `cancel` or `adhoc` properties; these dynamic settings are API only parameters.

// .Simple replication config
// ====
// [source,javascript]
// ----
// include::{example-cfg}[tags=icr-replication-config]
// ----
// ====

== Generic Constraints

.To run SGR-2 replications
[CAUTION]
--
All active nodes in active cluster must be running Sync Gateway version 2.8 or higher.
--

{enterprise}::
All replications are distributed evenly across available nodes. This means they cannot be guaranteed to run on the node from which they originate.

Access rights::
The user running the replication must have read and write access to the data being replicated.
This is not enforced by the system.
Use your `sync` function to ensure a consistent approach is applied across all clusters.

Mixing SGR1 and SGR2 replications::
Both protocols can legitimately be in use at the same time, especially during transition. However, you should avoid initializing identical SGR1 and SGR2 replications.

== Running Configured Replications

Replications in the configuration file start automatically whenever Sync Gateway is (re)started.
Unless you inhibit this by adding a `"state": "stopped"` parameter to the replication definition -- see: {xref-sgw-pg-config-properties-db-rep-state}.
You can manually start 'stopped' replication using {xref-sgw-pg-icr-admin-start}.

.Configured Replications -- Continuous and One-shot
=====
[{tabs}]
====
Continuous::
+
--
[source, json]
----
include::{example-cfg}[tags=icr-repl-create-pull-cont]
----

include::{example-cfg}[tag=icr-repl-create-pull-cont-callouts]
--

+
One-shot::
+
--
[source, json]
----
include::{example-cfg}[tag=icr-repl-create-pull-oneshot]
----

include::{example-cfg}[tag=icr-repl-create-pull-oneshot-callouts]
--

====
=====

== Running Admin REST API Replications

Replications initialized by sending a `POST`, or `PUT`, request to the `_replication` endpoint will start running automatically, unless the `"state": "stopped"` parameter is specified. with a JSON object defining the replication parameters -- as shown in  <<submitting-api-requests>>.

* You can run multiple replications simultaneously with different replication topologies, provided both databases being synchronized have the same sync function.

You can submit requests using the `curl` utility (as in these examples) or an application such as _Postman_.

[#submitting-api-requests]
.Submitting API Requests
=====
[{tabs}]
====
Continuous Pull Replication::
+
--
This example initializes a persistent, continuous, replication between a local database and one on a remote Sync Gateway instance.

[source, json]
----
include::{example-restapi}[tag=icr-repl-create-pull-cont]
----

include::{example-cfg}[tag=icr-rep-create-pull-cont-callouts]

--

One-shot::
+
--
This example initializes a persistent, one-shot, replication between a local database and one on a remote Sync Gateway instance.

The replication will run once, after a short delay to allow the Rest API to start.
It will then run once after each Sync Gateway restart and-or when manually initiated using the `_replicationStatus` endpoint -- see {xref-sgw-pg-icr-admin}.

[source, json]
----
include::{example-restapi}[tags=icr-repl-create-pull-oneshot]
----

include::{example-cfg}[tags=icr-repl-create-pull-oneshot-callouts]

--

Ad-hoc::
+
--

[source,javascript]
----
include::{example-restapi}[tags=icr-repl-adhoc-pull]
----

include::{example-cfg}[tags=icr-repl-adhoc-pull-callouts]
--

====
=====

include::partial$block-related-content-icr.adoc[]




// == Configuration Properties

// See: {xref-sgw-pg-config-properties} for a full description of the available configuration properties.

// You will find the replication properties defined here: {xref-sgw-pg-config-properties-db-replications}.

// The `_replicate` JSON Object supports the following properties.

// [cols="1,1,3,1"]
// |===
// |Name |Type |Description |Default

// |`source`
// |URL
// |_Required._ A URL pointing to the source database for the replication, the URL may be relative i.e. just the name of a local database on the Sync Gateway instance.
// The URL may point to the Admin REST API which will replicate all documents in the DB, or it may point to the public REST API which will only copy documents in the users assigned channels.
// When specifying credentials, the URL must be of the form `user:password@host`.
// |none

// |`target`
// |URL
// |_Required._ A URL pointing to the target database for the replication, the URL may be relative i.e. just the name of a local database on the Sync Gateway instance.
// The URL may point to the Admin REST API or it may point to the public REST API, this will impact the behavior of the target database sync function.
// When specifying credentials, the URL must be of the form `user:password@host`.
// |none

// |`continuous`
// |Boolean
// |_Optional._ Indicates whether the replication should be a one-shot or continuous replication.
// |false

// |`filter`
// |String
// |_Optional._ Passes the name of filter to apply to the source documents, currently the only supported filter is "sync_gateway/bychannel", this will replicate documents only from the set of named channels.
// |none

// |`query_params`
// |Object
// |_Optional._ Passes parameters to the filter, for the "sync_gateway/bychannel" filter the value should be an array or channel names (JSON strings).
// |none

// |`cancel`
// |Boolean
// |_Optional._ Indicates that a running replication task should be canceled, the running task is identified by passing its `replication_id` or by passing the original source and target values.
// |false

// |`replication_id`
// |String
// |_Optional._ If the cancel parameter is true then this is the id of the active replication task to be canceled, otherwise this is the `replication_id` to be used for the new replication.
// If no replication_id is given for a new replication it will be assigned a random UUID.
// |false

// |`async`
// |Boolean
// |_Optional._ Indicates that a one-shot replication should be run asynchronously and the request should return immediately.
// Replication progress can be monitored by using the `_active_tasks` resource.
// |false

// |`changes_feed_limit`
// |Number
// |_Optional._ The maximum number of change entries to pull in each loop of a continuous changes feed.
// |50
// |===




// {
//     "log":["*"],
//     "replications":[
//         {
//             "source": "db",
//             "target": "db-copy"
//         },
//         {
//             "source": "db",
//             "target": "http://user:password@example.com:4985/db-copy"
//         },
//         {
//             "replication_id":"continuous-remote-local",
//             "source": "http://user:password@example.com:4985/db-backup",
//             "target": "db"
//             "continuous":true
//         },
//         {
//             "replication_id":"continuous-filtered",
//             "source": "db",
//             "target": "http://user:password@example.com:4985/db-copy"
//             "continuous":true,
//             "changes_feed_limit":1000,
//             "filter":"sync_gateway/bychannel",
//             "query_params":["channel1","channel2"]
//         }
//     ],
//     "databases": {
//         "db": {
//             "server": "http://localhost:8091",
//             "bucket": "db",
//             "users": {
//                 "GUEST": {"disabled": false, "admin_channels": ["*"]}
//             }
//         },
//         "db-copy": {
//             "server": "http://localhost:8091",
//             "bucket": "db-copy",
//             "users": {
//                 "GUEST": {"disabled": false, "admin_channels": ["*"]}
//             }
//         }
//     }
// }
