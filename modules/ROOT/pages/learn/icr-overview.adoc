= Inter-Cluster Replication
:page-layout: article
:page-status: {release-status-sgw} -- {release-comments-sgw}
:page-edition: Under Development
:page-role:
:description: Inter-cluster replication (Sync Gateway to Sync Gateway) using SG-Replicate 2.0 protocol

include::partial$_std-hdr-sgw.adoc[]
include::partial$block-authors-notes.adoc[tag=wip]
:topic-group: Inter-cluster Replication
:param-related: {xref-sgw-pg-config-properties} | {xref-sgw-pg-rest-api-admin}
:param-abstract: This content provides an overview of Inter-cluster replication, which is replication between Sync Gateway clusters using SG-Replicate 2.0.
include::partial$block-abstract.adoc[]

// include::shared-mobile::partial$_attributes-shared.adoc[]
// include::partial$_attributes-local.adoc[]
// :xref-pfx-sgw: {xref-pfx-sgw}:
// include::partial$_page-index.adoc[]
// include::partial$_glossary-links.adoc[]

ifndef::release-status-sgw[:release-status-sgw!:]
ifeval::["{release-status-sgw}" == "gamma"]
[.pane_frame--orange]
.Author's Notes
--
Create an overview of the Sync Gateway replication process

.points to include

* replicator diagram https://docs.google.com/document/d/13E6JOq8u_AaUd_t8FZEPCAuq7jfkjryecjBQBHE3pG8/edit#heading=h.33gfct4o4z8t


High level intro with links to appropriate details topics

Document replication concepts and use-cases
High-availability sync-gateway cluster replication
Persistent vs ad hoc replication types
Replication use cases:
mobile cluster replications
cloud-edge/hub-spoke replication
protocol to enable replication between mobile clusters. That is, for example between a hub and its spoke clusters.
--
endif::[]


// Footnotes
:fn-icr: footnote:icr[As of Sync Gateway version 2.8]
:fn-arch: footnote:arch[This architecture is also known as 'ship-to-shore' or 'hub-and-spoke'.]
:fn-icr-ref: footnote:icr[]
:fn-arch-ref: footnote:arch[]


== Overview

Couchbase Sync Gateway supports _{glos-term-inter-cluster-replication}_, {fn-icr} an increasingly important enterprise-level requirement that
supports _{glos-term-cloud-to-edge} synchronization_ use cases, where data changes must be synchronized between a centralized cloud cluster and a large number of edge clusters whilst still enforcing fine grained access control.

Inter-cluster replication provides the ability to run replications between:

* Sync Gateway clusters
* Active mobile clusters.

Sync Gateway's inter-cluster replication feature uses the SG-Replicate protocol. It is an integral part of Sync Gateway, acting as the _{glos-term-active-replicator}_, pulling changes from a data source and pushing them to a target.

[[icr-architecture]]
.Inter-cluster replication architecture
====
image::icr-replication-overview.svg[]
====

All documents pass through the target Sync Gateway's _{glos-term-sync-function}_ instance, ensuring that access rules are honored. See: {xref-sgw-pg-adv-sgw-cfg-sync-function} for more on using `sync` functions)

In the architecture diagram (<<icr-architecture>>), any database changes made on either Sync Gateway instance are replicated to the other Sync Gateway instance, in accordance with the replication's configuration -- see {xref-sgw-pg-config-properties-db-replications} for configuration detail.


// == Feature Summary

// * Replication use cases include (see <<typical-use-cases>>):
// ** Mobile cluster replications
// ** Cloud-edge/hub-spoke replication
// * {xref-sgw-pg-icr-high-availability} (HA)
// * {xref-sgw-pg-icr-delta-sync} option
// * Create flexible replications using Sync Gateway's REST API -- see: {xref-sgw-pg-adv-rest-api-client}
// * Scalability
// * JSON configuration to specify replications
// * Supports multiple replications running concurrently
// * Supports multiple replication types: _{glos-term-persistent-replication}_ and _{glos-term-transient-replication}_ -- see {xref-sgw-pg-icr-replication-types}
// * Leverages the full duplex nature of websockets to support push and pull from a single connection -- see {xref-sgw-pg-config-properties-db-rep-direction}
// * Does not store anything persistently
// * Stateless -- can be interrupted/restarted anytime without negative side effects
// * Can specify which channel(s) to sync
// * Supports Primary/Primary and Primary/Secondary topologies


== Replication Types

Sync Gateway supports two replication types

Persistent::
+
--
Persistent replications survive Sync Gateway node restarts.
This is the default replication-type.

All replications created by configuring them in the {xref-sgw-pg-config-properties} file are persistent.
This is the recommended way to create replications in a production environment.

You can also create persistent replications by using the {xref-sgw-pg-rest-api-admin}.

--

Ad hoc::
+
--
Ad hoc replications exist only for the period of the replication. They can be created using the {xref-sgw-pg-rest-api-admin}.
Once created they start in the 'running' state. When they enter 'stopped', or 'error', state they are automatically removed.

Ad hoc replications provide a convenient way to:

* Run one off replications (for example, when troubleshooting)
* Run on-demand replications after Sync Gateway is started.
For instance a replication that needs to be to be run only periodically can be configured as an ad hoc replication by an automated script scheduled to run when needed.
--


== Use Cases

Cloud-to-edge synchronization::
+
--
In this multi-cloud deployment mode large numbers of multiple edge clusters sync with one or more clusters in cloud data centers. Each edge can operate autonomously without network connectivity to the cloud data centers {fn-arch}.

// SG-Replicate 2.0 delivers bi-directional sync, which:

// - is scalable
// - has high availability
// - features automatic and customizable conflict resolution options
// - has end-to-end security with fine grained access control.

// All very important considerations in this use case.

A typical architecture for this use cases is shown in <<icr-cloud-to-edge>>

[[icr-cloud-to-edge]]
.Cloud-to-edge synchronization
image::icr-cloud-to-edge200712.svg[,600]
--

Active-to-active Mobile Synchronization::
+
--
Here active mobile clusters at the edge are replicated between geographically separate cloud-based Sync Gateway deployments.

A typical architecture for this use cases is shown in <<icr-active-mobile>>

[[icr-active-mobile]]
.Active-active mobile synchronization
image::icr-active-mobile-sync200713.svg[,600]

--

// Alternative Methods::
// +
// --
// xref:server:manage:manage-xdcr/xdcr-management-overview.adoc[XDCR] (cross data centre replication) is the Couchbase Server API to replicate between Couchbase Server clusters.

// Both XDCR and SG Replicate 2.0 can be used to keep clusters in different data centres in sync.
// However, SG Replicate 2.0 was designed specifically for Couchbase Mobile deployments and must be used for replication between mobile clusters.
// --

// == Constraints

// SG-Replicate 2.0 will only replicate Sync Gateway databases hosted on versions of Sync Gateway later than March 7, 2014.

// High availability::
// +
// --
// In clusters containing multiple Sync Gateway nodes, only _one_ of the Sync Gateways should be configured fas the replicating node.

// Configuring multiple Sync Gateways as replicating nodes can substantially increase the amount of duplicate work, and therefore should be avoided.

// This limitation means the system cannot be guaranteed as Highly Available. If the replicating Sync Gateway fails or is otherwise removed from the system, then the replications will stop.
// --

== Conflict Resolution

include::page${sgw-pg-icr-conflict-resolution}[tag=overview]

See: {xref-sgw-pg-icr-conflict-resolution}

ifndef::release-status-sgw[:release-status-sgw!:]
ifeval::["{release-status-sgw}" == "gamma"]
[.pane_frame--orange]
.Author's Notes

== High-availability replication

include::page${sgw-pg-icr-high-availability}[tag=overview]

See: {xref-sgw-pg-icr-high-availability}


== Replication Monitoring

=== Replication Status
include::page${sgw-pg-icr-monitoring}[tag=overview]

See: {xref-sgw-pg-icr-monitoring}

=== Replication Stats

Sync Gateway also compiles a comprehensive set of statistics.

include::page${sgw-pg-icr-monitoring}[tag=stats]

// == Platform Capability

// [%autowidth]
// |===
// | capability |Edition | In CE | In EE

// | Replication configured in JSON config file
// | CE
// | Replication is created on every node it is configured on
// | The union of all configured replications is distributed across all config files

// | Replication created in REST API
// | CE
// | Replication is created on node from which the request is made
// | The union of all REST API created replications is distributed

// | Replication Monitoring using `_replication` and `_activeTasks`
// | CE
// | Will only return replications local to node on which request was made
// | --

// | Replication Monitoring using `_replicationStatus`
// | CE
// | Will only return replications local to node on which request was made
// |

// | Replication stats reporting (via _expvars)
// | CE
// |
// | Same in CE and EE

// | Default Conflict Resolution
// | CE
// |
// | Same in CE and EE

// | Out-of-box conflict resolvers (localWins,remoteWins)
// | EE
// |
// |

// | Custom conflict resolution
// | EE
// |
// |

// | Delta-Sync
// | EE
// |
// |

// | Built-in-High Availability
// | EE
// | If HA is required, then replicators must be explicitly configured/created on multiple nodes
// |

// | Filters with Channels
// | CE
// |
// | Same in CE and EE

// | Tuneable Parameters
// | EE
// |
// | TBD


// |===


== Administration

include::page${sgw-pg-icr-admin}[tag=overview]

See: {xref-sgw-pg-icr-admin}

== Filtering

PLACEHOLDER

== Authentication

PLACEHOLDER

== Replication Protocols
--
Talk about SGR1 and SGR2. Set deprecation context. Use diagrams.
--
endif::[]


include::partial$block-related-content-icr.adoc[]